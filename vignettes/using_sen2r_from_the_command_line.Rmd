---
title: "Using sen2r() from the command line"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using sen2r() from the command line}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, eval = FALSE}
library(sen2r)
sen2r()
```

Although the easiest way to set-up and launch a processing chain is probably by setting parameters with the GUI and launching it right away, it is often very useful to be able to launch a processing from the command line without opening the GUI.

This allows using \senr{} functionalities (provided both by the main function \rcmd{sen2r} or  other package functions) as part of more complex scripts, or scheduling a processing so to automatically update a time series of S2 products. Three main processing modes are availble: 

1. Specify all processing parameters in the call to `sen2r()` 
2. Load processing parameters from a previously saved JSON file
3. Load processing parameters froma previously saved JSON file, but change some of 
them in the call to `sen2r()`
 
## Specify all processing parameters directly in the call to `sen2r()`

In this case, the user is expected to specify all arguments required for processing 
within the call to `sen2r()` (See https://sen2r.ranghetti.info/reference/sen2r.html for a detailed description of each option - note that unspecified arguments will be set to Default values, when possible). 
For example, the following commands would download all S2 images acquired over the area specified in the 
"barbellino.geojson" spatial file between 01 and 15 July 2019, and create the following output products: 

1. BOA Reflectances; 
2. Scene Classification Map
3. Spectral Indices "NDVI" and "MSAVI2"
4. True Color RGB obtained from BOA reflectances 

, only for dates for which the cloud mask derived from the SCL dataset (type "cloud_and_shadow", in this case)
shows that less than 10% of the area of interest was covered by clouds: 

```{r eval=FALSE, warning=FALSE}
# Set paths for output folder and folder to store  downloaded SAFE
# (here we use subfolders of "R" tempdir)
out_dir  <- file.path(tempdir(), "/sen2r_outs")  
safe_dir <- file.path(tempdir(), "/sen2r_safes") 

out_dir
safe_dir

myextent <- system.file("extdata/vector/barbellino.geojson", package = "sen2r") 
out_paths <- sen2r(
  gui = FALSE,
  step_atmcorr = "l2a",
  extent = myextent,
  extent_name = "Barbellino",
  timewindow = c(as.Date("2019-07-03"), as.Date("2019-07-15")),
  list_prods = c("BOA","SCL"),
  list_indices = c("NDVI","MSAVI2"),
  list_rgb = c("RGB432B"),
  path_l2a = safe_dir,
  path_out = out_dir, 
  max_mask = 10, 
  mask_type = "cloud_and_shadow"
)
```

```{r eval=FALSE, warning=FALSE}

[2020-02-05 10:53:53] ####  Starting sen2r execution.  ####
Loading required namespace: stringi
[2020-02-05 10:53:57] Searching for available SAFE products on SciHub...
[2020-02-05 10:54:02] Computing output names...
Linking to GEOS 3.8.0, GDAL 3.0.2, PROJ 6.2.1
[2020-02-05 10:54:03] Processing group 1 of 5...
[2020-02-05 10:54:03] Starting to download the required level-2A SAFE products.
[2020-02-05 10:54:03] Check if products are available for download...
[2020-02-05 10:54:03] 1 Sentinel-2 images are already online.
[2020-02-05 10:54:03] Downloading Sentinel-2 image 1 of 1
                      (S2A_MSIL2A_20190703T101031_N0212_R022_T32TNS_20190703T134349.SAFE)...
  |===============================================================================================| 100%
[2020-02-05 10:54:41] Download of level-2A SAFE products terminated.

# SKIPPING MOST PROCESSING MESSAGES HERE#

```

A report summarizing the conducted processing is issued at the end of processing: 

```{r eval=FALSE, warning=FALSE}

╔════════════════════════════════════════════════════════════════════════════════════════════════════════════
║ sen2r Processing Report
╟────────────────────────────────────────────────────────────────────────────────────────────────────────────
║ Dates to be processed based on processing parameters: 5
║ Processing completed for: all expected dates.
║ Outputs for: 2 out of 5 expected dates not created because cloudiness over the spatial extent is above 10%.
╚════════════════════════════════════════════════════════════════════════════════════════════════════════════
[2020-02-05 11:02:53] ####  Execution of sen2r session terminated.  ####
The processing chain can be re-launched with the command:
  sen2r("/home/lb/.sen2r/proc_par/s2proc_20200205_105355.json")

```

In this case, it shows that, all the 5 S2 images satisfying the spatial-temporal query
were downloaded and properly processed. However, outputs for two of those dates were not
created because cloudiness over the spatial extent was above the specified threshold. 

S2 original SAFE images are stored in the folder specified by `safe_dir`, and are not 
eleted after processing (unless the user sets aso the argument `rm_safe` to TRUE).

```{r eval=FALSE, warning=FALSE}
list.files(safe_dir)
[1] "S2A_MSIL2A_20190703T101031_N0212_R022_T32TNS_20190703T134349.SAFE"
[2] "S2A_MSIL2A_20190706T102031_N0212_R065_T32TNS_20190706T134618.SAFE"
[3] "S2A_MSIL2A_20190713T101031_N0213_R022_T32TNS_20190713T135651.SAFE"
[4] "S2B_MSIL2A_20190708T101039_N0213_R022_T32TNS_20190708T133715.SAFE"
[5] "S2B_MSIL2A_20190711T102029_N0213_R065_T32TNS_20190711T135545.SAFE"
```

Outputs are automatically subsetted and masked over the study area, and stored in 
appropriate subfolders of `out_dir`. 

```{r eval=FALSE, warning=FALSE}
list.files(out_dir)
[1] "BOA"     "MSAVI2"  "NDVI"    "RGB432B" "SCL"    

list.files(file.path(out_dir, "NDVI"))
[1] "S2A2A_20190703_022_Barbellino_NDVI_10.tif" "S2A2A_20190706_065_Barbellino_NDVI_10.tif"
[3] "S2B2A_20190708_022_Barbellino_NDVI_10.tif" "thumbnails"  
```

(See XXXXXX for more info about folder structure and naming conventions of
`sen2r()` outputs)

## Load processing parameters from a previously saved JSON file

Users can set the desired parameters with the GUI, export them to a JSON file and run the command \rcmd{sen2r} specifying the JSON path in the argument \rarg{param_list} to specify processing options. For example, the command would launch `sen2r` using settings specified in file "myparams.json":

```{r eval=FALSE}
# set the path to an existing JSON file 
# - commented here, and substituted with an instruction that creates a test
# JOSN file
# json_path <- "/path/to/myparams.json"
json_path <- build_example_param_file()
json_path
[1] "/tmp/RtmpDLx7qh/file30ac6089ea3_sen2r_params.json"

out_paths <- sen2r(param_list = json_path)

[2020-02-05 11:58:09] ####  Starting sen2r execution.  ####
[2020-02-05 11:58:09] Searching for available SAFE products on SciHub...
[2020-02-05 11:58:12] Computing output names...
[2020-02-05 11:58:13] Starting to download the required level-2A SAFE products.
Images S2A_MSIL2A_20170703T101021_N0205_R022_T32TNS_20170703T101041.SAFE are already on your system and will be
skipped. Set "overwrite_safe" to TRUE to re-download them.

# SKIPPING MOST PROCESSING MESSAGES HERE#

╔══════════════════════════════════════════════════════════════════════════════════════════════════════════
║ sen2r Processing Report
╟──────────────────────────────────────────────────────────────────────────────────────────────────────────
║ Dates to be processed based on processing parameters: 1
║ Processing completed for: all expected dates.
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════
[2020-02-05 11:58:20] ####  Execution of sen2r session terminated.  ####
The processing chain can be re-launched with the command:
  sen2r("/home/lb/.sen2r/proc_par/s2proc_20200205_115809.json")
```

This is for example particularly useful if a `sen2r` processing requires ordering images from 
the LTA archive (see https://scihub.copernicus.eu/userguide/LongTermArchive).
The user can infact in that case: 

1. Set the processing parameters in the GUI and save them to JSON; 
2. Launch the processing a first time as shown above. `sen2r()` will process all already online dates, and automatically order the missing ones; 
3. Wait some time for the ordered images to be put back on line; 
4. Launch the processing again to complete the processing. 

(See https://luigi.ranghetti.info/post/order-s2-lta/ for a more detailed discussion about how lta orders are dealt with in `sen2r()`)

## Load processing parameters froma previously saved JSON file, but change some of 
them in the call to `sen2r()`

This allows users to use a previoudly saved JSON file as a "template" for a processing, but changing "manually" any desired parameter. For example, the following instructions: 

```{r eval=FALSE}
# set the path to an existing JSON file 
# - commented here, and substituted with an instruction that creates a test
# JOSN file
# json_path <- "/path/to/myparams.json"
json_path <- build_example_param_file()
json_path
[1] "/tmp/RtmpDLx7qh/file30ac6089ea3_sen2r_params.json"

myextent <- system.file("extdata/vector/scalve.kml", package = "sen2r")
out_dir <- "/path/wheretosave/sen2r/outputs_2"

out_paths <- sen2r(param_list = json_path, 
                   extent = myextent, 
                   extent_name = "newxtent",
                   timewindow = c(as.Date("2019-01-01"), as.Date("2019-01-30")),
                   path_out = out_dir)
```

would execute the same processing as in the previous example, but changing 
both the extent and time window of the analysis. This allows for example to easily 
run the same processing over different spatial/temporal extents. 
 
