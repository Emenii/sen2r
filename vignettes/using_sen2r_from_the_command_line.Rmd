---
title: "Using sen2r() from the command line"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Installation}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, eval = FALSE}
library(sen2r)
sen2r()
```

Although the easiest way to set-up and launch a processing chain is probably by setting parameters with the GUI and launching it right away, it is often very useful to be able to launch a processing from the command line without opening the GUI.

This allows using \senr{} functionalities (provided both by the main function \rcmd{sen2r} or  other package functions) as part of more complex scripts, or scheduling a processing so to automatically update a time series of S2 products. Three main processing modes are availble: 

1. Specify all processing parameters in the call to `sen2r()` 
2. Load processing parameters from a previously saved JSON file
3. Load processing parameters froma previously saved JSON file, but change some of 
them in the call to `sen2r()`
 
## Specifying all processing parameters directly in the call to `sen2r()`

In this case, the user is expected to specify all arguments required for processing 
within the call to `sen2r()` (See https://sen2r.ranghetti.info/reference/sen2r.html for a detailed description of each option - note that unspecified arguments will be set to Default values, when possible). 
For example, the following commands: 

```{r eval=FALSE}
out_dir  <- "/path/wheretosave/sen2r/outputs"
safe_dir <- "/path/wheretosave/SAFE"
myextent <- system.file("extdata/vector/barbellino.geojson", package = "sen2r") 
out_paths_3 <- sen2r(
  gui = FALSE,
  step_atmcorr = "l2a",
  extent = myextent,
  extent_name = "Barbellino",
  timewindow = c(as.Date("2019-07-03"), as.Date("2019-07-31")),
  list_prods = c("BOA","SCL"),
  list_indices = c("NDVI","MSAVI2"),
  list_rgb = c("RGB432B"),
  path_l2a = safe_dir,
  path_out = out_dir
)
```

would download all S2 images acquired over the area specified in the 
"barbellino.geojson" spatial file in July 2019, and create the following output products: 

1. BOA Reflectances; 
2. Scene Classification Map
3. Spectral Indices "NDVI" and "MSAVI2"
4. True Color RGB obtained from BOA reflectances

Ouputs are automatically subsetted and masked over the study area, and stored in 
appropriate subfolders of `out_dir`. S2 original SAFE images are stored in the folder 
specified by `safe_dir`, and are not deleted after processing (unless the user sets
also the argument `rm_safe` to TRUE).


## Load processing parameters from a previously saved JSON file

In this case, users can set the desired parameters with the GUI, export them to a JSON file and run the command \rcmd{sen2r} specifying the JSON path in the argument \rarg{param_list} to specify processing options. For example, the command:

```{r eval=FALSE}
# set the path to an existing JSON file 
# - commented here, and substituted with an instruction that creates a test
# JOSN file
# json_path <- "/path/to/myparams.json"
json_path <- build_example_param_file()
json_path
[1] "/tmp/RtmpDLx7qh/file30ac6089ea3_sen2r_params.json"

out_paths <- sen2r(param_list = json_path)
```

would launch `sen2r` using settings specified in file "myparams.json".

This is particularly useful if a `sen2r` processing requires ordering images from 
the LTA archive (see XXXXXX). The user can infact in this case: 

1. Set the processing parameters in the GUI and save them to JSON; 
2. Launch the processing a first time as shown above. `sen2r()` will process all already online dates, and automatically order the missing ones; 
3. Wait some time for the ordered images to be put back on line; 
4. Launch the processing again to complete the processing. 

## Load processing parameters froma previously saved JSON file, but change some of 
them in the call to `sen2r()`

This allows users to use a previoudly saved JSON file as a "template" for a processing, but changing "manually" any desired parameter. For example, the following instructions: 

```{r eval=FALSE}
# set the path to an existing JSON file 
# - commented here, and substituted with an instruction that creates a test
# JOSN file
# json_path <- "/path/to/myparams.json"
json_path <- build_example_param_file()
json_path
[1] "/tmp/RtmpDLx7qh/file30ac6089ea3_sen2r_params.json"

myextent <- system.file("extdata/vector/scalve.kml", package = "sen2r")
out_dir <- "/path/wheretosave/sen2r/outputs_2"

out_paths <- sen2r(param_list = json_path, 
                   extent = myextent, 
                   timewindow = c(as.Date("2020-01-01"), as.Date("2019-01-30")),
                   path_out = out_dir)
```

would execute the same processing as in the previous example, but changing 
both the extent and time window of the analysis. 
 
